<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Producto - Rosita Admin</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { db, storage } from './firebase-config.js';
        import { collection, addDoc, getDocs, getDoc, query, where, updateDoc, doc, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.orderBy = orderBy;
        window.storage = storage;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
    </script>
    <style>
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gris-claro);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            color: var(--gris-medio);
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: var(--rosa-principal);
        }
        
        .tab.active {
            color: var(--rosa-principal);
            border-bottom-color: var(--rosa-principal);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .producto-card {
            background: var(--blanco);
            border: 2px solid var(--gris-claro);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .producto-card:hover {
            border-color: var(--rosa-principal);
            box-shadow: 0 4px 12px rgba(178, 58, 97, 0.2);
            transform: translateY(-2px);
        }
        
        .producto-card.selected {
            border-color: var(--rosa-principal);
            background: var(--rosa-claro);
        }
        
        .producto-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .producto-card h4 {
            margin: 0 0 5px 0;
            color: var(--rosa-principal);
            font-size: 1.1em;
        }
        
        .producto-card .category-badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--gris-claro);
            border-radius: 4px;
            font-size: 0.8em;
            color: var(--gris-medio);
            margin-top: 5px;
        }
        
        .producto-card .variants-count {
            font-size: 0.85em;
            color: var(--gris-medio);
            margin-top: 8px;
        }
        
        .filters-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters-section input,
        .filters-section select {
            padding: 10px;
            border: 1px solid var(--gris-medio);
            border-radius: 5px;
            min-width: 200px;
        }
        
        .form-two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-two-columns {
                grid-template-columns: 1fr;
            }
        }
        
        .section-divider {
            margin: 30px 0;
            border-top: 2px dashed var(--gris-claro);
            padding-top: 20px;
        }
        
        .section-title {
            color: var(--rosa-principal);
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .selected-product-info {
            background: var(--rosa-claro);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .selected-product-info h3 {
            margin: 0;
            color: var(--rosa-principal);
        }
        
        .btn-cancel-selection {
            background: var(--gris-medio);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="images/logo-sin-fondo.png" alt="Rosita" class="logo-grande" style="max-width: 100px;">
            <h1>Agregar Producto</h1>
        </header>
        
        <nav>
            <a href="index.html">üè† Inicio</a>
            <a href="agregar-producto.html">‚ûï Agregar Producto</a>
            <a href="gestionar-productos.html">üìã Gestionar Productos</a>
            <a href="gestionar-precios.html">üí∞ Gestionar Precios</a>
            <a href="ver-pedidos.html">üì¶ Ver Pedidos</a>
            <a href="ver-clientes.html">üë• Ver Clientes</a>
            <a href="cargar-receta.html">üìù Cargar Receta</a>
        </nav>
        
        <main>
            <h2 class="page-title">Gestionar Productos y Variantes</h2>
            
            <div id="message"></div>
            
            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab active" onclick="mostrarTab('productos')">üìã Seleccionar Producto Existente</button>
                <button class="tab" onclick="mostrarTab('nuevo')">‚ûï Crear Nuevo Producto</button>
                    </div>
                    
            <!-- Tab: Seleccionar Producto Existente -->
            <div id="tabProductos" class="tab-content active">
                <div class="filters-section">
                    <input type="text" id="searchProductos" placeholder="üîç Buscar producto..." oninput="filtrarProductos()">
                    <select id="categoryFilter" onchange="filtrarProductos()">
                        <option value="">Todas las categor√≠as</option>
                            <option value="pollo">Pollo</option>
                            <option value="vacuno">Vacuno</option>
                            <option value="cerdo">Cerdo</option>
                            <option value="embutidos">Embutidos</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    
                <div id="loading" class="loading">Cargando productos...</div>
                <div id="productosContainer" class="productos-grid"></div>
                
                <!-- Formulario de Variante (se muestra cuando se selecciona un producto) -->
                <div id="varianteSection" style="display: none;" class="section-divider">
                    <div class="selected-product-info">
                        <h3 id="selectedProductName">Producto seleccionado</h3>
                        <button class="btn btn-cancel-selection" onclick="cancelarSeleccion()">Cancelar Selecci√≥n</button>
                    </div>
                    
                    <div class="form-container">
                        <h3 class="section-title">‚ûï Agregar Nueva Variante</h3>
                <form id="varianteForm">
                    <div class="form-group">
                        <label for="marcaNombre">Nombre de la Marca/Variante *</label>
                        <input type="text" id="marcaNombre" name="marcaNombre" placeholder="Ej: Tresnal, Fresco, Premium" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="imagenVariante">Imagen de la variante *</label>
                                <input type="file" id="imagenVariante" name="imagenVariante" accept="image/*">
                        <small>Sube la foto espec√≠fica de esta marca/presentaci√≥n.</small>
                    </div>
                    
                    <div class="image-preview" id="varianteImagePreview" style="display: none;">
                        <p>Imagen actual de la variante:</p>
                        <img id="varianteImagePreviewImg" src="" alt="Imagen de la variante">
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n de la Variante *</label>
                        <textarea id="descripcion" name="descripcion" rows="3" placeholder="Ej: Viene envasado al vac√≠o, se vende por unidad" required></textarea>
                    </div>
                    
                            <div class="form-two-columns">
                    <div class="form-group">
                        <label for="precio">Precio ($) *</label>
                        <input type="number" id="precio" name="precio" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="sellBy">Formato de Venta *</label>
                        <select id="sellBy" name="sellBy" required onchange="togglePesoField()">
                            <option value="">Seleccione formato</option>
                            <option value="unidad">Por Unidad</option>
                            <option value="kg">Por Kilogramo</option>
                        </select>
                                </div>
                    </div>
                    
                    <div class="form-group" id="pesoGroup" style="display: none;">
                        <label for="peso">Peso (kg)</label>
                        <input type="number" id="peso" name="peso" step="0.1" min="0" placeholder="Ej: 5">
                    </div>
                    
                    <div class="form-group">
                        <label for="minimumKg">M√≠nimo de Compra (kg)</label>
                        <input type="number" id="minimumKg" name="minimumKg" step="0.1" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Opciones de Corte/Entrega</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="entero" style="margin-right: 8px; width: auto;">
                                Entero
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="bifes-1-dedo" style="margin-right: 8px; width: auto;">
                                Bifes a 1 dedo
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="bifes-2-dedos" style="margin-right: 8px; width: auto;">
                                Bifes a 2 dedos
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="bifes-3-dedos" style="margin-right: 8px; width: auto;">
                                Bifes a 3 dedos
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="banderita" style="margin-right: 8px; width: auto;">
                                Banderita
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="cortado-3-dedos" style="margin-right: 8px; width: auto;">
                                Cortado a 3 dedos
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="cortado-5-dedos" style="margin-right: 8px; width: auto;">
                                Cortado a 5 dedos
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="picado" style="margin-right: 8px; width: auto;">
                                Picado
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="formatOptions" value="milanesas" style="margin-right: 8px; width: auto;">
                                Milanesas
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Opciones de Hueso</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="boneOptions" value="con-hueso" style="margin-right: 8px; width: auto;">
                                Con Hueso
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="boneOptions" value="sin-hueso" style="margin-right: 8px; width: auto;">
                                Sin Hueso
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="inStock" name="inStock" checked style="margin-right: 8px; width: auto;">
                            En Stock
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="featured" name="featured" style="margin-right: 8px; width: auto;">
                            Producto Destacado
                        </label>
                    </div>
                    
                    <button type="submit" class="btn">Guardar Variante</button>
                            <button type="button" class="btn btn-secondary" onclick="resetVarianteForm()" style="margin-left: 10px;">Limpiar Formulario</button>
                </form>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Crear Nuevo Producto -->
            <div id="tabNuevo" class="tab-content">
                <div class="form-container">
                    <h3 class="section-title">üì¶ Informaci√≥n del Producto Base</h3>
                    <form id="productoCompletoForm">
                        <div class="form-group">
                            <label for="nombreBaseNuevo">Nombre del Corte/Producto *</label>
                            <input type="text" id="nombreBaseNuevo" name="nombreBaseNuevo" placeholder="Ej: Bife de Chorizo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="categoriaNuevo">Categor√≠a *</label>
                            <select id="categoriaNuevo" name="categoriaNuevo" required>
                                <option value="">Seleccione una categor√≠a</option>
                                <option value="pollo">Pollo</option>
                                <option value="vacuno">Vacuno</option>
                                <option value="cerdo">Cerdo</option>
                                <option value="embutidos">Embutidos</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="imagenFileNuevo">Imagen principal del producto *</label>
                            <input type="file" id="imagenFileNuevo" name="imagenFileNuevo" accept="image/*" required>
                            <small>Formatos aceptados: JPG, PNG, WEBP. Tama√±o recomendado: 800x600 px.</small>
                        </div>
                        
                        <div class="section-divider" id="primeraVarianteSection">
                            <h3 class="section-title">‚ûï Primera Variante del Producto</h3>
                            <p style="color: var(--gris-medio); margin-bottom: 20px;">Al crear el producto, tambi√©n se crear√° autom√°ticamente su primera variante.</p>
                            
                            <div class="form-group">
                                <label for="marcaNombreNuevo">Nombre de la Marca/Variante *</label>
                                <input type="text" id="marcaNombreNuevo" name="marcaNombreNuevo" placeholder="Ej: Tresnal, Fresco, Premium" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="imagenVarianteNuevo">Imagen de la variante *</label>
                                <input type="file" id="imagenVarianteNuevo" name="imagenVarianteNuevo" accept="image/*" required>
                                <small>Sube la foto espec√≠fica de esta marca/presentaci√≥n.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="descripcionNuevo">Descripci√≥n de la Variante *</label>
                                <textarea id="descripcionNuevo" name="descripcionNuevo" rows="3" placeholder="Ej: Viene envasado al vac√≠o, se vende por unidad" required></textarea>
                            </div>
                            
                            <div class="form-two-columns">
                                <div class="form-group">
                                    <label for="precioNuevo">Precio ($) *</label>
                                    <input type="number" id="precioNuevo" name="precioNuevo" step="0.01" min="0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="sellByNuevo">Formato de Venta *</label>
                                    <select id="sellByNuevo" name="sellByNuevo" required onchange="togglePesoFieldNuevo()">
                                        <option value="">Seleccione formato</option>
                                        <option value="unidad">Por Unidad</option>
                                        <option value="kg">Por Kilogramo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" id="pesoGroupNuevo" style="display: none;">
                                <label for="pesoNuevo">Peso (kg)</label>
                                <input type="number" id="pesoNuevo" name="pesoNuevo" step="0.1" min="0" placeholder="Ej: 5">
                            </div>
                            
                            <div class="form-group">
                                <label for="minimumKgNuevo">M√≠nimo de Compra (kg)</label>
                                <input type="number" id="minimumKgNuevo" name="minimumKgNuevo" step="0.1" min="0" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label>Opciones de Corte/Entrega</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="entero" style="margin-right: 8px; width: auto;">
                                        Entero
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="bifes-1-dedo" style="margin-right: 8px; width: auto;">
                                        Bifes a 1 dedo
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="bifes-2-dedos" style="margin-right: 8px; width: auto;">
                                        Bifes a 2 dedos
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="bifes-3-dedos" style="margin-right: 8px; width: auto;">
                                        Bifes a 3 dedos
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="banderita" style="margin-right: 8px; width: auto;">
                                        Banderita
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="cortado-3-dedos" style="margin-right: 8px; width: auto;">
                                        Cortado a 3 dedos
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="cortado-5-dedos" style="margin-right: 8px; width: auto;">
                                        Cortado a 5 dedos
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="picado" style="margin-right: 8px; width: auto;">
                                        Picado
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="formatOptionsNuevo" value="milanesas" style="margin-right: 8px; width: auto;">
                                        Milanesas
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Opciones de Hueso</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="boneOptionsNuevo" value="con-hueso" style="margin-right: 8px; width: auto;">
                                        Con Hueso
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="boneOptionsNuevo" value="sin-hueso" style="margin-right: 8px; width: auto;">
                                        Sin Hueso
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="inStockNuevo" name="inStockNuevo" checked style="margin-right: 8px; width: auto;">
                                    En Stock
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="featuredNuevo" name="featuredNuevo" style="margin-right: 8px; width: auto;">
                                    Producto Destacado
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn">Crear Producto y Primera Variante</button>
                        <button type="reset" class="btn btn-secondary" style="margin-left: 10px;">Limpiar Formulario</button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const messageDiv = document.getElementById('message');
        let productosData = [];
        let productoSeleccionado = null;
        let productoBaseId = null;
        let productoBaseImagen = '';
        let pendienteSeleccion = null;
        let editandoVariante = false;
        let varianteDocId = null;
        let varianteImagenActual = '';
        let varianteEditData = null;
        let editandoProductoBase = false;
        let productoBaseEdicionId = null;
        let productoBaseImagenActual = '';
        let productoBaseNombreOriginal = '';
        
        const uploadImage = async (file, path) => {
            if (!file) return '';
            const storageRef = ref(window.storage, path);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            return url;
        };
        
        function mostrarTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'productos') {
                if (editandoProductoBase) {
                    restaurarModoCreacionBase();
                }
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('tabProductos').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('tabNuevo').classList.add('active');
            }
        }
        
        function togglePesoField() {
            const sellBy = document.getElementById('sellBy').value;
            const pesoGroup = document.getElementById('pesoGroup');
            pesoGroup.style.display = sellBy === 'unidad' ? 'block' : 'none';
        }
        
        function togglePesoFieldNuevo() {
            const sellBy = document.getElementById('sellByNuevo').value;
            const pesoGroup = document.getElementById('pesoGroupNuevo');
            pesoGroup.style.display = sellBy === 'unidad' ? 'block' : 'none';
        }
        
        async function cargarProductos() {
            const loadingDiv = document.getElementById('loading');
            const containerDiv = document.getElementById('productosContainer');
            
            try {
                const q = window.query(window.collection(window.db, 'products'), window.orderBy('name', 'asc'));
                const querySnapshot = await window.getDocs(q);
                
                loadingDiv.style.display = 'none';
                productosData = [];
                const productosBase = {};
                
                querySnapshot.forEach((docSnap) => {
                    const producto = docSnap.data();
                    const baseProduct = producto.baseProduct || producto.name.split(' - ')[0] || producto.name;
                    
                    if (!productosBase[baseProduct]) {
                        productosBase[baseProduct] = {
                            name: baseProduct,
                            category: producto.category || producto.categoria || 'Sin categor√≠a',
                            image: producto.image || producto.image_url || '',
                            variants: []
                        };
                    }
                    
                    if (producto.variant || producto.name.includes(' - ')) {
                        productosBase[baseProduct].variants.push(producto);
                    }
                });
                
                productosData = Object.values(productosBase);
                renderizarProductos();
                aplicarPendienteSeleccion();
                
            } catch (error) {
                console.error('Error al cargar productos:', error);
                loadingDiv.style.display = 'none';
                containerDiv.innerHTML = '<div class="message error">‚ùå Error al cargar los productos</div>';
            }
        }
        
        function renderizarProductos() {
            const containerDiv = document.getElementById('productosContainer');
            
            if (productosData.length === 0) {
                containerDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--gris-medio);">No hay productos registrados. Crea uno nuevo en la pesta√±a "Crear Nuevo Producto".</p>';
                return;
            }
            
            let html = '';
            productosData.forEach((producto, index) => {
                const variantsCount = producto.variants.length;
                html += `
                    <div class="producto-card" onclick="seleccionarProducto(${index})" data-index="${index}">
                        ${producto.image ? `<img src="${producto.image}" alt="${producto.name}">` : '<div style="height: 150px; background: var(--gris-claro); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gris-medio);">Sin imagen</div>'}
                        <h4>${producto.name}</h4>
                        <span class="category-badge">${producto.category}</span>
                        <div class="variants-count">${variantsCount} variante${variantsCount !== 1 ? 's' : ''}</div>
                    </div>
                `;
            });
            
            containerDiv.innerHTML = html;
        }

        function aplicarPendienteSeleccion() {
            if (!pendienteSeleccion) {
                return;
            }

            if (pendienteSeleccion.type === 'productoBase') {
                prepararEdicionProductoBase(pendienteSeleccion.data);
            } else if (pendienteSeleccion.type === 'variante') {
                const baseName = pendienteSeleccion.data.baseName || pendienteSeleccion.data.name;
                const index = productosData.findIndex(p => p.name === baseName);
                if (index !== -1) {
                    seleccionarProducto(index, { editarVariante: pendienteSeleccion.data });
                } else {
                    messageDiv.innerHTML = '<div class="message error">‚ùå No se encontr√≥ el producto seleccionado para edici√≥n.</div>';
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                    }, 4000);
                }
            }

            pendienteSeleccion = null;
        }
        
        function filtrarProductos() {
            const searchTerm = (document.getElementById('searchProductos').value || '').toLowerCase();
            const categoryFilter = (document.getElementById('categoryFilter').value || '').toLowerCase();
            
            const productosFiltrados = productosData.filter(p => {
                const matchSearch = !searchTerm || p.name.toLowerCase().includes(searchTerm);
                const matchCategory = !categoryFilter || p.category.toLowerCase() === categoryFilter;
                return matchSearch && matchCategory;
            });
            
            const containerDiv = document.getElementById('productosContainer');
            const originalData = productosData;
            productosData = productosFiltrados;
            renderizarProductos();
            productosData = originalData;
        }
        
        async function seleccionarProducto(index, options = {}) {
            productoSeleccionado = productosData[index];
            
            // Buscar el producto base en Firebase
            try {
                const q = window.query(
                    window.collection(window.db, 'products'),
                    window.where('name', '==', productoSeleccionado.name)
                );
                const snapshot = await window.getDocs(q);
                
                if (!snapshot.empty) {
                    productoBaseId = snapshot.docs[0].id;
                    const data = snapshot.docs[0].data();
                    productoBaseImagen = data.image || data.image_url || '';
                } else {
                    // Si no existe como base, buscar variantes
                    const q2 = window.query(
                        window.collection(window.db, 'products'),
                        window.where('baseProduct', '==', productoSeleccionado.name)
                    );
                    const snapshot2 = await window.getDocs(q2);
                    if (!snapshot2.empty) {
                        const firstVariant = snapshot2.docs[0].data();
                        productoBaseImagen = firstVariant.baseImage || firstVariant.image || '';
                    }
                }
            } catch (error) {
                console.error('Error al buscar producto:', error);
            }
            
            // Marcar como seleccionado visualmente
            document.querySelectorAll('.producto-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`.producto-card[data-index="${index}"]`).classList.add('selected');
            
            // Mostrar formulario de variante
            document.getElementById('selectedProductName').textContent = productoSeleccionado.name;
                document.getElementById('varianteSection').style.display = 'block';
            document.getElementById('varianteSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Limpiar formulario
            resetVarianteForm();
            if (options.editarVariante) {
                prepararEdicionVariante(options.editarVariante);
            }
        }
        
        function cancelarSeleccion() {
            productoSeleccionado = null;
            productoBaseId = null;
            productoBaseImagen = '';
            document.querySelectorAll('.producto-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('varianteSection').style.display = 'none';
            resetVarianteForm();
        }

        function prepararEdicionVariante(data) {
            editandoVariante = true;
            varianteDocId = data.id || null;
            varianteImagenActual = data.image || data.image_url || '';
            varianteEditData = data;

            const imagenInput = document.getElementById('imagenVariante');
            if (imagenInput) {
                imagenInput.required = false;
            }

            document.getElementById('marcaNombre').value = data.variant || (data.name && data.name.split(' - ')[1]) || data.name || '';
                document.getElementById('descripcion').value = data.description || '';
                document.getElementById('precio').value = data.price || 0;
                
            const sellByValue = data.sellBy ||
                (data.sale_format && data.sale_format.toLowerCase().includes('unidad') ? 'unidad' :
                    (data.sale_format && data.sale_format.toLowerCase().includes('kg') ? 'kg' : ''));
            if (sellByValue) {
                document.getElementById('sellBy').value = sellByValue;
                }
                togglePesoField();
                
            const minimo = data.minimumKg || data.minimum_kg || '';
            document.getElementById('minimumKg').value = minimo || 0;

            if (sellByValue === 'unidad') {
                document.getElementById('peso').value = minimo || '';
            } else {
                document.getElementById('peso').value = '';
            }

            setCheckedValues('formatOptions', data.formatOptions || []);
            setCheckedValues('boneOptions', data.boneOptions || []);

            document.getElementById('inStock').checked = data.inStock !== false;
            document.getElementById('featured').checked = !!data.featured;

            const preview = document.getElementById('varianteImagePreview');
            const previewImg = document.getElementById('varianteImagePreviewImg');
            if (varianteImagenActual && preview && previewImg) {
                previewImg.src = varianteImagenActual;
                preview.style.display = 'block';
            }

            const submitBtn = document.querySelector('#varianteForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Guardar cambios';
            }

            messageDiv.innerHTML = '<div class="message">‚úèÔ∏è Editando variante existente. Ajusta los datos y guarda los cambios.</div>';
        }

        function setCheckedValues(name, values) {
            const valuesSet = new Set(values || []);
            document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
                cb.checked = valuesSet.has(cb.value);
            });
        }

        function configurarCamposVarianteNuevoRequeridos(activo) {
            ['marcaNombreNuevo', 'imagenVarianteNuevo', 'descripcionNuevo', 'precioNuevo', 'sellByNuevo'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.required = activo;
                }
            });
        }

        function prepararEdicionProductoBase(data) {
            editandoProductoBase = true;
            productoBaseEdicionId = data.id || null;
            productoBaseImagenActual = data.image || data.image_url || '';
            productoBaseNombreOriginal = data.name || '';

            mostrarTab('nuevo');

            const form = document.getElementById('productoCompletoForm');
            if (form) {
                form.reset();
            }

            const nombreInput = document.getElementById('nombreBaseNuevo');
            if (nombreInput) {
                nombreInput.value = data.name || '';
            }

            const categoriaSelect = document.getElementById('categoriaNuevo');
            if (categoriaSelect) {
                const normalized = (data.category || '').toLowerCase();
                const opciones = Array.from(categoriaSelect.options).map(option => option.value);
                if (opciones.includes(normalized)) {
                    categoriaSelect.value = normalized;
                } else if (data.category && opciones.includes(data.category)) {
                    categoriaSelect.value = data.category;
                } else {
                    categoriaSelect.value = '';
                }
            }

            const imagenInput = document.getElementById('imagenFileNuevo');
            if (imagenInput) {
                imagenInput.value = '';
                imagenInput.required = false;
            }

            configurarCamposVarianteNuevoRequeridos(false);

            const varianteSection = document.getElementById('primeraVarianteSection');
            if (varianteSection) {
                varianteSection.style.display = 'none';
            }

            const submitBtn = document.querySelector('#productoCompletoForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Guardar cambios del producto base';
            }

            messageDiv.innerHTML = '<div class="message">‚úèÔ∏è Editando el producto base seleccionado. Carga una nueva imagen solo si quer√©s reemplazarla.</div>';
        }

        function restaurarModoCreacionBase() {
            editandoProductoBase = false;
            productoBaseEdicionId = null;
            productoBaseImagenActual = '';
            productoBaseNombreOriginal = '';
            messageDiv.innerHTML = '';

            const imagenInput = document.getElementById('imagenFileNuevo');
            if (imagenInput) {
                imagenInput.required = true;
                imagenInput.value = '';
            }

            configurarCamposVarianteNuevoRequeridos(true);

            const varianteSection = document.getElementById('primeraVarianteSection');
            if (varianteSection) {
                varianteSection.style.display = '';
            }

            const submitBtn = document.querySelector('#productoCompletoForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Crear Producto y Primera Variante';
            }

            togglePesoFieldNuevo();
        }

        async function actualizarVariantesBase(nombreAnterior, nombreNuevo, categoria, imagenBaseUrl) {
            const variantesRef = window.collection(window.db, 'products');
            const updates = [];
            const idsActualizados = new Set();
            const ahora = new Date().toISOString();

            if (!nombreAnterior) {
                nombreAnterior = nombreNuevo;
            }

            const snapshotBase = await window.getDocs(
                window.query(variantesRef, window.where('baseProduct', '==', nombreAnterior))
            );

            snapshotBase.forEach(docSnap => {
                idsActualizados.add(docSnap.id);
                const data = docSnap.data();
                const variantName = data.variant || (data.name && data.name.includes(' - ') ? data.name.split(' - ')[1] : '');
                const nuevoNombreCompleto = variantName ? `${nombreNuevo} - ${variantName}` : nombreNuevo;
                updates.push(window.updateDoc(docSnap.ref, {
                    baseProduct: nombreNuevo,
                    name: nuevoNombreCompleto,
                    category: categoria,
                    baseImage: imagenBaseUrl,
                    updated_at: ahora
                }));
            });

            const prefix = `${nombreAnterior} - `;
            const snapshotFallback = await window.getDocs(
                window.query(
                    variantesRef,
                    window.where('name', '>=', prefix),
                    window.where('name', '<=', `${prefix}\uf8ff`)
                )
            );

            snapshotFallback.forEach(docSnap => {
                if (idsActualizados.has(docSnap.id)) {
                    return;
                }
                const data = docSnap.data();
                const variantName = data.variant || (data.name && data.name.includes(' - ') ? data.name.split(' - ')[1] : '');
                const nuevoNombreCompleto = variantName ? `${nombreNuevo} - ${variantName}` : nombreNuevo;
                updates.push(window.updateDoc(docSnap.ref, {
                    baseProduct: nombreNuevo,
                    name: nuevoNombreCompleto,
                    category: categoria,
                    baseImage: imagenBaseUrl,
                    updated_at: ahora
                }));
            });

            if (updates.length > 0) {
                await Promise.all(updates);
            }
        }

        function seleccionarProductoPorNombre(nombre, options = {}) {
            const index = productosData.findIndex(p => p.name === nombre);
            if (index !== -1) {
                seleccionarProducto(index, options);
            }
        }
        
        // Formulario de Variante (para productos existentes)
        document.getElementById('varianteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!productoSeleccionado || !productoBaseId) {
                messageDiv.innerHTML = '<div class="message error">‚ùå Debes seleccionar un producto primero.</div>';
                return;
            }
            
            const formatOptions = Array.from(document.querySelectorAll('input[name="formatOptions"]:checked')).map(cb => cb.value);
            const boneOptions = Array.from(document.querySelectorAll('input[name="boneOptions"]:checked')).map(cb => cb.value);
            const imagenVarianteFile = document.getElementById('imagenVariante').files[0];
            const esEdicion = editandoVariante && varianteDocId;
            
            if (!esEdicion && !imagenVarianteFile) {
                messageDiv.innerHTML = '<div class="message error">‚ùå Debes subir la imagen de la variante.</div>';
                return;
            }
            
            const variante = {
                name: document.getElementById('marcaNombre').value,
                description: document.getElementById('descripcion').value,
                price: parseFloat(document.getElementById('precio').value),
                sellBy: document.getElementById('sellBy').value,
                sale_format: document.getElementById('sellBy').value === 'unidad' ? 'Por unidad' : 'Por kilogramo',
                inStock: document.getElementById('inStock').checked,
                featured: document.getElementById('featured').checked,
                formatOptions: formatOptions,
                boneOptions: boneOptions,
            };
            
            if (document.getElementById('sellBy').value === 'unidad') {
                const peso = parseFloat(document.getElementById('peso').value);
                if (peso) {
                    variante.minimumKg = peso;
                    variante.minimum_kg = peso;
                }
            }
            
            const minimumKg = parseFloat(document.getElementById('minimumKg').value);
            if (minimumKg > 0) {
                variante.minimumKg = minimumKg;
                variante.minimum_kg = minimumKg;
            }
            
            try {
                const ahora = new Date().toISOString();
                if (esEdicion) {
                    variante.created_at = varianteEditData?.created_at || ahora;
                    variante.updated_at = ahora;
                } else {
                    variante.created_at = ahora;
                    variante.updated_at = ahora;
                }

                const nombreCompleto = productoSeleccionado.name + ' - ' + variante.name;
                const slugBase = productoSeleccionado.name.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-');
                const slugVariante = variante.name.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-');
                
                let varianteUrl = varianteImagenActual;
                if (imagenVarianteFile) {
                    varianteUrl = await uploadImage(imagenVarianteFile, `products/${slugBase}/variantes/${slugVariante}-${Date.now()}`);
                }
                if (!varianteUrl) {
                    varianteUrl = productoBaseImagen;
                }
                
                const productoCompleto = {
                    name: nombreCompleto,
                    baseProduct: productoSeleccionado.name,
                    variant: variante.name,
                    category: productoSeleccionado.category,
                    image: varianteUrl,
                    image_url: varianteUrl,
                    baseImage: productoBaseImagen,
                    ...variante
                };
                
                if (esEdicion) {
                    await window.updateDoc(window.doc(window.db, 'products', varianteDocId), productoCompleto);
                    messageDiv.innerHTML = '<div class="message success">‚úÖ Variante actualizada correctamente</div>';
                } else {
                    await window.addDoc(window.collection(window.db, 'products'), productoCompleto);
                    messageDiv.innerHTML = '<div class="message success">‚úÖ Variante agregada correctamente</div>';
                }

                resetVarianteForm();
                cargarProductos();
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error al guardar la variante:', error);
                messageDiv.innerHTML = '<div class="message error">‚ùå Error al guardar la variante. Intente nuevamente.</div>';
            }
        });
        
        // Formulario de Producto Completo (nuevo producto + primera variante)
        document.getElementById('productoCompletoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const esEdicionBase = editandoProductoBase && productoBaseEdicionId;
            const nombreBase = document.getElementById('nombreBaseNuevo').value;
            const categoria = document.getElementById('categoriaNuevo').value;
            const imagenFile = document.getElementById('imagenFileNuevo').files[0];
            const imagenVarianteFile = document.getElementById('imagenVarianteNuevo').files[0];
            
            if (esEdicionBase) {
                try {
                    let imagenBaseUrl = productoBaseImagenActual;
                    const slug = nombreBase.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-');
                    
                    if (imagenFile) {
                        imagenBaseUrl = await uploadImage(imagenFile, `products/${slug}/main-${Date.now()}`);
                    }
                    
                    await window.updateDoc(window.doc(window.db, 'products', productoBaseEdicionId), {
                        name: nombreBase,
                        category: categoria,
                        image: imagenBaseUrl,
                        image_url: imagenBaseUrl,
                        updated_at: new Date().toISOString()
                    });

                    const nombreAnterior = productoBaseNombreOriginal || nombreBase;
                    await actualizarVariantesBase(nombreAnterior, nombreBase, categoria, imagenBaseUrl);

                    messageDiv.innerHTML = '<div class="message success">‚úÖ Producto base actualizado correctamente</div>';
                    restaurarModoCreacionBase();
                    mostrarTab('productos');
                    cargarProductos();

                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);

                } catch (error) {
                    console.error('Error al actualizar el producto base:', error);
                    messageDiv.innerHTML = '<div class="message error">‚ùå Error al actualizar el producto base. Intente nuevamente.</div>';
                }

                return;
            }

            if (!imagenFile || !imagenVarianteFile) {
                messageDiv.innerHTML = '<div class="message error">‚ùå Debes subir ambas im√°genes (producto base y variante).</div>';
                return;
            }
            
            try {
                // Subir imagen del producto base
                const slug = nombreBase.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-');
                const imagenBaseUrl = await uploadImage(imagenFile, `products/${slug}/main-${Date.now()}`);
                
                // Crear producto base
                const productoBase = {
                    name: nombreBase,
                    category: categoria,
                    image: imagenBaseUrl,
                    image_url: imagenBaseUrl,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const docRef = await window.addDoc(window.collection(window.db, 'products'), productoBase);
                productoBaseId = docRef.id;
                
                // Crear primera variante
                const formatOptions = Array.from(document.querySelectorAll('input[name="formatOptionsNuevo"]:checked')).map(cb => cb.value);
                const boneOptions = Array.from(document.querySelectorAll('input[name="boneOptionsNuevo"]:checked')).map(cb => cb.value);
                
                const variante = {
                    name: document.getElementById('marcaNombreNuevo').value,
                    description: document.getElementById('descripcionNuevo').value,
                    price: parseFloat(document.getElementById('precioNuevo').value),
                    sellBy: document.getElementById('sellByNuevo').value,
                    sale_format: document.getElementById('sellByNuevo').value === 'unidad' ? 'Por unidad' : 'Por kilogramo',
                    inStock: document.getElementById('inStockNuevo').checked,
                    featured: document.getElementById('featuredNuevo').checked,
                    formatOptions: formatOptions,
                    boneOptions: boneOptions,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                if (document.getElementById('sellByNuevo').value === 'unidad') {
                    const peso = parseFloat(document.getElementById('pesoNuevo').value);
                    if (peso) {
                        variante.minimumKg = peso;
                        variante.minimum_kg = peso;
                    }
                }
                
                const minimumKg = parseFloat(document.getElementById('minimumKgNuevo').value);
                if (minimumKg > 0) {
                    variante.minimumKg = minimumKg;
                    variante.minimum_kg = minimumKg;
                }
                
                const nombreCompleto = nombreBase + ' - ' + variante.name;
                const slugVariante = variante.name.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-');
                const varianteUrl = await uploadImage(imagenVarianteFile, `products/${slug}/variantes/${slugVariante}-${Date.now()}`);
                
                const productoCompleto = {
                    name: nombreCompleto,
                    baseProduct: nombreBase,
                    variant: variante.name,
                    category: categoria,
                    image: varianteUrl,
                    image_url: varianteUrl,
                    baseImage: imagenBaseUrl,
                    ...variante
                };
                
                await window.addDoc(window.collection(window.db, 'products'), productoCompleto);
                
                messageDiv.innerHTML = '<div class="message success">‚úÖ Producto y primera variante creados correctamente</div>';
                document.getElementById('productoCompletoForm').reset();
                cargarProductos();
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                    mostrarTab('productos');
                }, 3000);
                
            } catch (error) {
                console.error('Error al crear producto:', error);
                messageDiv.innerHTML = '<div class="message error">‚ùå Error al crear el producto. Intente nuevamente.</div>';
            }
        });
        
        function resetVarianteForm() {
            const form = document.getElementById('varianteForm');
            if (form) {
                form.reset();
            }
            editandoVariante = false;
            varianteDocId = null;
            varianteImagenActual = '';
            varianteEditData = null;

            const imagenInput = document.getElementById('imagenVariante');
            if (imagenInput) {
                imagenInput.value = '';
                imagenInput.required = true;
            }

            document.getElementById('inStock').checked = true;
            document.getElementById('featured').checked = false;
            togglePesoField();

            const preview = document.getElementById('varianteImagePreview');
            if (preview) {
                preview.style.display = 'none';
            }

            const submitBtn = document.querySelector('#varianteForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Guardar Variante';
            }
        }
        
        // Verificar si est√° ejecut√°ndose desde file://
        if (window.location.protocol === 'file:') {
            messageDiv.innerHTML = `
                <div class="message error" style="padding: 20px; font-size: 1.1em;">
                    <strong>‚ö†Ô∏è ERROR: Est√°s abriendo el archivo directamente</strong><br><br>
                    Para que Firebase Storage funcione, necesitas ejecutar un servidor local.<br><br>
                    <strong>Soluciones r√°pidas:</strong><br>
                    1. <strong>Python:</strong> Abre terminal en esta carpeta y ejecuta: <code>python -m http.server 8000</code><br>
                    2. <strong>Node.js:</strong> Ejecuta: <code>npx http-server -p 8000</code><br>
                    3. Luego abre: <strong>http://localhost:8000/agregar-producto.html</strong>
                </div>
            `;
        }
        
        // Cargar productos al iniciar y procesar ediciones pendientes
        window.addEventListener('DOMContentLoaded', () => {
            const editarProductoBaseRaw = sessionStorage.getItem('editarProductoBase');
            if (editarProductoBaseRaw) {
                try {
                    const data = JSON.parse(editarProductoBaseRaw);
                    pendienteSeleccion = { type: 'productoBase', data };
                    mostrarTab('nuevo');
                } catch (error) {
                    console.error('Error al restaurar el producto base a editar:', error);
                }
                sessionStorage.removeItem('editarProductoBase');
            }

            const editarVarianteRaw = sessionStorage.getItem('editarVariante');
            if (editarVarianteRaw) {
                try {
                    varianteEditData = JSON.parse(editarVarianteRaw);
                    pendienteSeleccion = { type: 'variante', data: varianteEditData };
                    mostrarTab('productos');
                } catch (error) {
                    console.error('Error al restaurar la variante a editar:', error);
                }
                sessionStorage.removeItem('editarVariante');
            }

            cargarProductos();
        });
    </script>
</body>
</html>
